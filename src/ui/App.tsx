
import React, { useEffect, useMemo, useState } from "react";
type Knowledge = any; type Step = any;
type Selections = { mode?: "Digital" | "Digital & Print"; eventType?: string; guests?: string; format?: "Postkarte" | "Streifen" | "GroÃŸbild"; accessories?: { requisiten?: boolean; hintergrund?: boolean; layout?: boolean }; printRecommendation?: string; };
type Message = { role: "assistant" | "user"; text: string };
const RAW = "https://raw.githubusercontent.com/Sascha-Fotobox/KI-Agent-Dennis/main/public/knowledge.json";
const App: React.FC = () => {
  const [K,setK]=useState<Knowledge|null>(null); const [err,setErr]=useState<string|null>(null);
  const [msgs,setMsgs]=useState<Message[]>([]); const [step,setStep]=useState(1); const [sub,setSub]=useState(0);
  const [sel,setSel]=useState<Selections>({ accessories:{requisiten:false,hintergrund:false,layout:false} });
  useEffect(()=>{(async()=>{const urls=[RAW,`${import.meta.env.BASE_URL}knowledge.json`,`/knowledge.json`,`knowledge.json`];let e:any=null;for(const u of urls){try{const r=await fetch(u,{cache:"no-store"});if(!r.ok)throw new Error(String(r.status));setK(JSON.parse(await r.text()));setErr(null);return;}catch(err0){e=err0;}}setErr(String(e));})()},[]);
  const addB=(t:string)=>setMsgs(m=>[...m,{role:"assistant",text:t}]); const addU=(t:string)=>setMsgs(m=>[...m,{role:"user",text:t}]);
  const stepById=(id:number):Step|undefined=>K?.button_flow?.steps?.find((s:any)=>s.id===id);
  const norm=(l?:string)=>!l?"":/geburt/i.test(l)?"Geburtstag":/hochzeit/i.test(l)?"Hochzeit":/abschluss/i.test(l)?"Abschlussball":/internes/i.test(l)?"Internes Mitarbeiterevent":/externes/i.test(l)?"Externes Kundenevent":/Ã¶ffentlich|party/i.test(l)?"Ã–ffentliche Veranstaltung":l;
  useEffect(()=>{if(!K)return; setMsgs([{role:"assistant",text:"Hi! Ich begleite dich Schritt fÃ¼r Schritt zur passenden Fotobox. MÃ¶chtest du die Fotobox ðŸ“± Digital nutzen oder ðŸ–¨ï¸ Digital & Print?"}]); setStep(1); setSub(0); setSel({accessories:{requisiten:false,hintergrund:false,layout:false}});},[K]);
  const onChoice=(c:string)=>{ addU(c);
    if(step===1){const m=c.includes("Digital & Print")?"Digital & Print":"Digital"; setSel(p=>({...p,mode:m})); if(m==="Digital"){addB("Top! Digital bedeutet unbegrenzt viele Fotos, QR-Downloads und eine DSGVO-konforme Online-Galerie â€“ nachhaltig und flexibel.

Lass uns noch kurz dein ZubehÃ¶r anschauen."); setStep(5); setSub(0); return;} addB("Alles klar â€“ mit Sofortdruck. Was wird gefeiert?"); setStep(2); return; }
    if(step===2){ setSel(p=>({...p,eventType:c})); const s2:any=stepById(2); const rec=s2?.recommendations?.[c]||""; const bridge=s2?.after_reply?.text||"Klingt gut! Magst du mir sagen, wie viele GÃ¤ste ungefÃ¤hr erwartet werden?"; addB([rec,bridge].filter(Boolean).join("\n\n")); setStep(3); return; }
    if(step===3){ setSel(p=>({...p,guests:c})); const s3:any=stepById(3); const ek=norm(sel.eventType); const spec=s3?.special_contexts?.[ek]?.[c]; const rec=spec||s3?.recommendations?.[c]||""; setSel(p=>({...p,printRecommendation:rec})); addB([rec,"Als NÃ¤chstes: Welches Druckformat wÃ¼nscht ihr euch?"].join("\n\n")); setStep(4); return; }
    if(step===4){ const f:c any= c.startsWith("ðŸ“¸")?"Postkarte":c.startsWith("ðŸŽžï¸")?"Streifen":"GroÃŸbild"; setSel(p=>({...p,format:f})); const s4:any=stepById(4); const rec=s4?.recommendations?.[c]||""; const bridge=s4?.after_reply?.text||"Super, dann berÃ¼cksichtige ich dieses Format fÃ¼r deine PreisÃ¼bersicht am Ende. Lass uns jetzt noch kurz dein ZubehÃ¶r anschauen."; addB([rec,bridge].filter(Boolean).join("\n\n")); setStep(5); setSub(0); return; }
    if(step===5){ const subs=(stepById(5) as any)?.substeps??[]; const s=subs[sub]; if(s){ const yes=c.startsWith("âœ…"); const key = s.key as keyof NonNullable<Selections["accessories"]>; setSel(p=>({...p,accessories:{...(p.accessories||{}),[key]:yes}})); const conf=yes?s.confirm_yes:s.confirm_no; if(conf) addB(conf); } const nxt=sub+1; if(nxt<subs.length){ setSub(nxt); const ns=subs[nxt]; if(ns?.say) addB(ns.say); } else { setStep(6); const summary=buildSummary(sel); const price=buildPriceText(sel,K); addB(["Kurze Zusammenfassung deiner Auswahl:",summary,"Transparente PreisÃ¼bersicht:",price].join("\n\n")); } return; }
  };
  if(err) return <div className="app"><header className="header"><h1>FOBI Fotobox â€“ Assistent</h1></header><main className="chat"><div className="msg assistant"><div className="bubble"><strong>Knowledge konnte nicht geladen werden.</strong>{"\n"}Details: {err}{"\n"}Bitte prÃ¼fe die RAW-URL auf GitHub.</div></div></main></div>;
  if(!K) return <div className="app"><header className="header"><h1>FOBI Fotobox â€“ Assistent</h1></header><main className="chat"><div className="msg assistant"><div className="bubble">Knowledge wird geladen â€¦</div></div></main></div>;
  const cur:any=stepById(step); const buttons:string[]=cur?.buttons??[];
  return (<div className="app"><header className="header"><h1>{K.brand} â€“ Assistent â€ž{K.assistant_name}â€œ</h1><small>{K.privacy_notice}</small></header><main className="chat">{msgs.map((m,i)=>(<div key={i} className={`msg ${m.role}`}><div className="bubble">{m.text}</div></div>))}<div className="step">{cur?.title&&<h2>{cur.title}</h2>}{cur?.ask&&<p className="ask">{cur.ask}</p>}{step===4&&(<div className="info">{(stepById(4) as any)?.info&&<p>{(stepById(4) as any).info}</p>}<ul><li>{(stepById(4) as any)?.change_intervals?.Postkartenformat}</li><li>{(stepById(4) as any)?.change_intervals?.Fotostreifenformat}</li><li>{(stepById(4) as any)?.change_intervals?.GroÃŸbildformat}</li></ul></div>)}{buttons.length>0&&(<div className="buttons">{buttons.map(b=>(<button key={b} onClick={()=>onChoice(b)}>{b}</button>))}</div>)}{step===5&&renderAccessoryButtons(sub, stepById(5) as any, onChoice)}</div></main><footer className="footer"><small>TonalitÃ¤t: {K.language_tone}</small></footer></div>);
};
function renderAccessoryButtons(sub:number, step5:any, onChoice:(c:string)=>void){const subs=step5?.substeps??[]; const s=subs[sub]; if(!s) return null; const btns:string[]=s.buttons??[]; return (<div className="buttons">{btns.map(b=>(<button key={b} onClick={()=>onChoice(b)}>{b}</button>))}</div>);}
function buildSummary(sel:Selections){const parts:string[]=[]; parts.push(`Modus: ${sel.mode==="Digital"?"Digital (Fobi Smart, digitale Nutzung inkl.)":"Digital & Print"}`); if(sel.eventType)parts.push(`Event: ${sel.eventType}`); if(sel.guests)parts.push(`GÃ¤ste: ${sel.guests}`); if(sel.format)parts.push(`Druckformat: ${sel.format==="Postkarte"?"Postkartenformat (10Ã—15)":sel.format==="Streifen"?"Fotostreifen (5Ã—15)":"GroÃŸbildformat (15Ã—20)"}`); const acc=sel.accessories||{}; const accL:string[]=[]; if(acc.requisiten)accL.push("Requisiten"); if(acc.hintergrund)accL.push("Hintergrund"); if(acc.layout)accL.push("Individuelles Layout"); if(accL.length)parts.push(`ZubehÃ¶r: ${accL.join(", ")}`); if(sel.printRecommendation)parts.push(`Empfehlung: ${sel.printRecommendation}`); parts.push("Hinweise: 400 Prints im Postkartenformat entsprechen automatisch 800 Fotostreifen; beim GroÃŸbildformat entspricht ein Printpaket 200 â†’ 100 GroÃŸbild-Prints."); return "â€¢ "+parts.join("\nâ€¢ ");}
function buildPriceText(sel:Selections,K:Knowledge){const p=K.pricing||{}; const items:Array<{label:string;price:number}>=[]; if(sel.mode==="Digital")items.push({label:"Digitalpaket (Fobi Smart)",price:p["Digitalpaket (Fobi Smart)"]||0}); if(sel.mode==="Digital & Print"){const it=recommendPrintPackageFromGuests(sel,K); if(it)items.push(it); const ek=normalizeEventKeyLocal(sel.eventType); if(ek==="Externes Kundenevent"){items.push({label:"Hinweis: Bei Messen/Promotions/Recruitingdays erfolgt die Abrechnung nach Verbrauch in 100er-Schritten. Media-Kit + Reserve-Kit werden gestellt.",price:0});}} const acc=sel.accessories||{}; const chosen=["requisiten","hintergrund","layout"].filter(k=>(acc as any)[k]); if(chosen.length>1){const extras=chosen.length-1; items.push({label:`Weitere ZubehÃ¶rpakete (${extras}Ã—)`,price:extras*(K.pricing?.["Jedes weitere ZubehÃ¶rpaket"]||0)});} const sum=items.reduce((a,b)=>a+(b.price||0),0); const lines=items.map(i=>i.price>0?`â€¢ ${i.label}: ${i.price} â‚¬`:`â€¢ ${i.label}`); lines.push(`\n**Gesamtsumme: ${sum} â‚¬**`); return lines.join("\n");}
function recommendPrintPackageFromGuests(sel:Selections,K:Knowledge){const g=sel.guests; let label=""; if(g==="0â€“30 Personen")label="200 Prints (Postkartenformat)"; if(g==="30â€“50 Personen")label="200 Prints (Postkartenformat)"; if(g==="50â€“120 Personen")label="400 Prints (Postkartenformat)"; if(g==="120â€“250 Personen")label="800 Prints (Postkartenformat, 1 Drucksystem)"; if(g==="ab 250 Personen")label=""; if(!label)return null; const price=K?.pricing?.[label]; if(price==null)return null; return {label,price};}
function normalizeEventKeyLocal(l?:string){if(!l)return""; if(/geburt/i.test(l))return"Geburtstag"; if(/hochzeit/i.test(l))return"Hochzeit"; if(/abschluss/i.test(l))return"Abschlussball"; if(/internes/i.test(l))return"Internes Mitarbeiterevent"; if(/externes/i.test(l))return"Externes Kundenevent"; if(/Ã¶ffentlich|party/i.test(l))return"Ã–ffentliche Veranstaltung"; return l;}
export default App;
